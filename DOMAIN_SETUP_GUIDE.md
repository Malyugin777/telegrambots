# Настройка домена на Reg.ru — Пошаговая инструкция

## Предварительные требования

- Домен, зарегистрированный на Reg.ru (например, `example.com`)
- VPS сервер с внешним IP-адресом (например, `123.45.67.89`)
- SSH доступ к серверу
- Docker и Docker Compose установлены на сервере

---

## Шаг 1: Узнать IP-адрес вашего VPS

Если не знаете IP своего сервера:

```bash
# Подключитесь к серверу по SSH и выполните:
curl ifconfig.me
```

Запишите этот IP-адрес (например, `123.45.67.89`).

---

## Шаг 2: Настройка DNS в панели Reg.ru

### 2.1. Войдите в панель управления

1. Перейдите на [reg.ru](https://www.reg.ru)
2. Нажмите "Личный кабинет" → "Войти"
3. Введите логин и пароль

### 2.2. Перейдите к управлению доменом

1. В личном кабинете нажмите "Мои домены"
2. Найдите нужный домен и нажмите на него
3. В меню слева выберите "DNS-серверы и управление зоной"
4. Нажмите "Управление зоной" или "Редактировать DNS-записи"

### 2.3. Добавьте A-записи

Вам нужно создать 2 записи:

#### Запись 1: Основной домен

| Поле | Значение |
|------|----------|
| Тип записи | A |
| Хост | @ (или оставьте пустым) |
| Значение | 123.45.67.89 (ваш IP) |
| TTL | 3600 (или оставьте по умолчанию) |

#### Запись 2: Поддомен admin

| Поле | Значение |
|------|----------|
| Тип записи | A |
| Хост | admin |
| Значение | 123.45.67.89 (ваш IP) |
| TTL | 3600 |

### 2.4. Сохраните изменения

Нажмите "Сохранить" или "Применить".

### 2.5. Дождитесь обновления DNS

DNS-записи обновляются от 5 минут до 48 часов. Обычно 15-30 минут.

Проверить можно командой:
```bash
# На своём компьютере
nslookup admin.example.com

# Или
ping admin.example.com
```

Должен показать ваш IP-адрес.

---

## Шаг 3: Подготовка сервера

### 3.1. Подключитесь к серверу

```bash
ssh user@123.45.67.89
```

### 3.2. Создайте директорию проекта

```bash
mkdir -p /opt/nexus
cd /opt/nexus
```

### 3.3. Загрузите проект

```bash
# Через Git (если есть репозиторий)
git clone https://github.com/your-repo/nexus_project.git .

# Или через SCP с локального компьютера
# (выполните на локальном компьютере)
scp -r ./nexus_project/* user@123.45.67.89:/opt/nexus/
```

### 3.4. Создайте .env файл

```bash
cd /opt/nexus/infrastructure
cp .env.example .env
nano .env  # Заполните реальными значениями
```

---

## Шаг 4: Настройка Nginx для вашего домена

### 4.1. Отредактируйте nginx.conf

```bash
nano /opt/nexus/infrastructure/nginx/nginx.conf
```

Замените `admin.example.com` на ваш реальный домен:

```nginx
# Найдите и замените все вхождения:
server_name admin.example.com;
# На:
server_name admin.yourdomain.ru;
```

---

## Шаг 5: Получение SSL-сертификата

### 5.1. Отредактируйте скрипт получения сертификата

```bash
nano /opt/nexus/infrastructure/init-letsencrypt.sh
```

Измените настройки в начале файла:

```bash
domains=(admin.yourdomain.ru)      # Ваш домен
email="your-real-email@gmail.com"   # Ваш email для уведомлений
staging=0                            # 0 = боевой режим, 1 = тестовый
```

### 5.2. Запустите скрипт

```bash
chmod +x init-letsencrypt.sh
./init-letsencrypt.sh
```

Скрипт:
1. Создаст временный самоподписанный сертификат
2. Запустит Nginx
3. Получит реальный сертификат от Let's Encrypt
4. Перезагрузит Nginx

### 5.3. Проверьте результат

```bash
# Должны появиться файлы сертификатов:
ls -la ./certbot/conf/live/admin.yourdomain.ru/
```

---

## Шаг 6: Запуск проекта

```bash
cd /opt/nexus/infrastructure
docker compose up -d
```

Проверьте, что всё работает:

```bash
docker compose ps
```

Все контейнеры должны быть в статусе "Up".

---

## Шаг 7: Проверка работы

### 7.1. Откройте в браузере

```
https://admin.yourdomain.ru
```

Должна открыться страница входа в админку.

### 7.2. Создайте первого администратора

На странице входа нажмите "First time? Create admin account" и создайте аккаунт.

---

## Устранение проблем

### Проблема: Сайт не открывается

1. Проверьте, что DNS обновился:
   ```bash
   nslookup admin.yourdomain.ru
   ```

2. Проверьте, что порты открыты:
   ```bash
   sudo ufw allow 80
   sudo ufw allow 443
   ```

3. Проверьте логи Nginx:
   ```bash
   docker compose logs nginx
   ```

### Проблема: Ошибка SSL

1. Убедитесь, что DNS правильно настроен
2. Подождите 5-10 минут после изменения DNS
3. Попробуйте сначала с `staging=1` в скрипте
4. Проверьте логи certbot:
   ```bash
   docker compose logs certbot
   ```

### Проблема: 502 Bad Gateway

API не запустился. Проверьте:
```bash
docker compose logs api
```

---

## Автоматическое обновление сертификатов

Certbot автоматически обновляет сертификаты каждые 12 часов (настроено в docker-compose.yml). Nginx перезагружается каждые 6 часов для применения новых сертификатов.

---

## Итоговая структура DNS

| Тип | Хост | Значение | Назначение |
|-----|------|----------|------------|
| A | @ | 123.45.67.89 | Основной домен |
| A | admin | 123.45.67.89 | Админ-панель |
| A | api | 123.45.67.89 | API (опционально) |

---

## Полезные команды

```bash
# Перезапуск всех сервисов
docker compose restart

# Просмотр логов
docker compose logs -f

# Обновление проекта
git pull
docker compose build
docker compose up -d

# Принудительное обновление сертификата
docker compose run --rm certbot renew --force-renewal
docker compose exec nginx nginx -s reload
```
