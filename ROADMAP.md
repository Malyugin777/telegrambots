# NEXUS ROADMAP

## Текущий статус: Фаза 3 ЗАВЕРШЕНА ✅

### Выполнено:
- [x] Исправлен график активности (включает сегодня)
- [x] Исправлен подсчёт юзеров бота
- [x] Исправлен парсинг details в логах
- [x] Статистика по платформам (Pie chart)
- [x] Drag & Drop загрузка изображений
- [x] Профиль пользователя с активностью
- [x] Версия в футере
- [x] Исправлен aspect ratio видео (SAR fix)
- [x] **JSON парсинг ffprobe (критический баг)** — v1.2.1

---

## ФАЗА 3: Исправление видео + Счётчик ошибок

### 3.1 Видео Aspect Ratio ✅ ЗАВЕРШЕНО
- [x] Проверка SAR через ffprobe (JSON формат)
- [x] Если SAR=1:1 и H.264 — пропускаем
- [x] Если кодек не H.264 — перекодируем в H.264
- [x] Если SAR≠1:1 — scale с явным расчётом пикселей
- [x] Исправлено в rapidapi_downloader.py и downloader.py
- [x] Детальное логирование [FIX_VIDEO] / [FIX_TIKTOK]

### 3.2 Страница ошибок /errors ✅ ЗАВЕРШЕНО
- [x] Таблица ошибок с фильтрами
- [x] Статистика: всего, сегодня, по платформам
- [x] Используется ActionLog с action='error'

---

## ФАЗА 4: Billing Tracker (Трекер оплат)

### Таблица `subscriptions`:
```sql
CREATE TABLE subscriptions (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),           -- "Aeza VPS", "RapidAPI", "Hostkey"
    provider_url VARCHAR(255),    -- Ссылка на ЛК
    amount DECIMAL(10,2),
    currency VARCHAR(3),          -- RUB, USD
    billing_cycle VARCHAR(20),    -- monthly, yearly
    next_payment_date DATE,
    auto_renew BOOLEAN,
    notes TEXT,
    created_at TIMESTAMP
);
```

### Функционал:
- [ ] CRUD подписок через админку
- [ ] Страница /subscriptions в меню
- [ ] Dashboard виджет "Ближайшие платежи"
- [ ] Telegram уведомления за 7/3/1 день до оплаты
- [ ] История платежей

---

## ФАЗА 5: Bot Customization (Настройка бота)

### 5.1 Редактор сообщений
```
Таблица bot_messages:
- id
- bot_id
- message_type (start, help, download_success, error, etc.)
- text_ru
- text_en
- updated_at
```

### Функционал:
- [ ] Страница /bot-settings в админке
- [ ] Редактор текстов с превью
- [ ] Переменные: {username}, {filename}, {size}, {duration}
- [ ] Markdown/HTML форматирование

### 5.2 Кастомизация UI бота
- [ ] Inline кнопки (настраиваемые)
- [ ] Эмодзи в сообщениях
- [ ] Выбор языка по умолчанию

---

## ФАЗА 6: Performance Monitor

### 6.1 Метрики скачивания
```python
# В ActionLog добавить поля:
- download_time_ms: int      # Время скачивания
- file_size_bytes: int       # Размер файла
- download_speed_kbps: int   # Скорость KB/s
```

### 6.2 Dashboard виджеты:
- [ ] Средняя скорость скачивания
- [ ] Средний размер файла
- [ ] Время отклика по платформам

### 6.3 Мониторинг серверов (опционально):
- [ ] CPU/RAM usage (через API хостинга или скрипт)
- [ ] Дисковое пространство
- [ ] Uptime

---

## ФАЗА 7: Деплой на Hostkey

### Текущая архитектура:
```
HOSTKEY (66.151.33.167)          AEZA (185.96.80.254)
├── PostgreSQL :5432              ├── API (FastAPI) :8000
├── Redis :6379                   ├── Frontend (shadow-api.ru)
└── bot_manager                   └── Nginx + SSL
    └── @SaveNinja_bot
```

### Задачи:
- [ ] Автоматический деплой через GitHub Actions
- [ ] Мониторинг контейнеров
- [ ] Логи в централизованное хранилище

---

## ФАЗА 8: VPN Bot (Новый проект)

### Концепция:
- Telegram бот для продажи VPN
- Интеграция с Outline/WireGuard
- Оплата через Telegram Stars / криптой

### Задачи:
- [ ] Архитектура
- [ ] Выбор VPN протокола
- [ ] Интеграция оплаты
- [ ] Админка для управления ключами

---

## ПРИОРИТЕТЫ

| Приоритет | Задача | Сложность | Статус |
|-----------|--------|-----------|--------|
| ~~1~~ | ~~Фаза 3: Видео SAR + Ошибки~~ | ~~Средняя~~ | ✅ Готово |
| 1 | Billing Tracker | Средняя | Следующий |
| 2 | Bot Customization | Средняя | - |
| 3 | Performance Monitor | Средняя | - |
| 4 | VPN Bot | Высокая | Отдельный проект |

---

## ПРАВИЛА РАБОТЫ С CLAUDE CODE

### Скорость:
```
ЛОКАЛЬНО: Редактирование, npm build, тесты
СЕРВЕР: Только деплой (scp, git pull, docker restart)
```

### Эффективные промпты:
```
✅ "Работай ЛОКАЛЬНО в C:\Projects\TelegramBots"
✅ "Покажи план, потом делай"
✅ "НЕ делай npm install на сервере"
✅ Маленькие задачи вместо "сделай всё"

❌ Длинные сессии (контекст теряется)
❌ Сборка на сервере с 1 ядром
```

### Субагенты:
Это нормально — Claude запускает параллельные задачи для чтения файлов.
Ускоряет работу при исследовании кодовой базы.

### Токены:
Показываются в конце задачи. Если прервал — не покажет.
